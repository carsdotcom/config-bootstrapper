/*!
 * Config Bootstrapper v0.0.2 <https://github.com/carsdotcom>
 * @license Apache 2.0
 * @copyright 2015 Cars.com <http://www.cars.com/>
 * @author Mac Heller-Ogden <mheller-ogden@cars.com>
 * @summary A simple configuration bootstrapper
 */
!function(name,definition){"undefined"!=typeof module&&module.exports?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):(function(){return this||(0,eval)("this")}())[name]=definition()}("ConfigBootstrapper",function(){function ConfigBootstrapper(options){options="object"==typeof options?options:{},options.refreshRate=options.refreshRate||300,options.dataStorageKey=options.dataStorageKey||"configBootstrapper.data",options.timestampStorageKey=options.timestampStorageKey||"configBootstrapper.timestamp",this.options=options}var NodeLocalStorage;return("undefined"==typeof localStorage||null===localStorage)&&(NodeLocalStorage=require("node-localstorage").LocalStorage,localStorage=new NodeLocalStorage("./localstorage-temp-data")),("undefined"==typeof XMLHttpRequest||null===XMLHttpRequest)&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest),ConfigBootstrapper.prototype.ready=function(callback){var cbs=this;this._getJson(this.options.url,callback),setTimeout(function refreshHandler(){cbs._getJson(cbs.options.url,function(){}),setTimeout(refreshHandler,cbs.options.refreshRate)},this.options.refreshRate)},ConfigBootstrapper.prototype._getJson=function(url,callback){var cbs,ts,now,xhr;cbs=this,ts=parseInt(localStorage.getItem(cbs.options.timestampStorageKey),10),now=Date.now(),!ts||now>=ts+1e3*cbs.options.refreshRate?(xhr=new XMLHttpRequest,xhr.open("GET",url,!0),xhr.onreadystatechange=function(){4==xhr.readyState&&(200===xhr.status&&(localStorage.setItem(cbs.options.dataStorageKey,xhr.responseText),localStorage.setItem(cbs.options.timestampStorageKey,now)),callback())},xhr.send()):callback()},ConfigBootstrapper});