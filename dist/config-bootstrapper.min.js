/*!
 * Config Bootstrapper v0.0.6 <https://github.com/carsdotcom/config-bootstrapper>
 * @license Apache 2.0
 * @copyright 2015 Cars.com <http://www.cars.com/>
 * @author Mac Heller-Ogden <mheller-ogden@cars.com>
 * @summary A simple configuration bootstrapper
 */
!function(name,definition){"undefined"!=typeof module&&module.exports?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):(function(){return this||(0,eval)("this")}())[name]=definition()}("ConfigBootstrapper",function(){function ConfigBootstrapper(options){var cbs=this;options="object"==typeof options?options:{},options.refreshRate=options.refreshRate||300,options.dataStorageKey=options.dataStorageKey||"configBootstrapper.data",options.timestampStorageKey=options.timestampStorageKey||"configBootstrapper.timestamp",options.timeout=options.timeout||4e3,cbs.options=options,cbs.isReady=!1,cbs.timeoutCounter=0,cbs.readyPollRate=50,cbs._loadData(),setTimeout(function refreshHandler(){cbs._loadData(),setTimeout(refreshHandler,options.refreshRate)},options.refreshRate)}var NodeLocalStorage;return("undefined"==typeof localStorage||null===localStorage)&&(NodeLocalStorage=require("node-localstorage").LocalStorage,localStorage=new NodeLocalStorage("./localstorage-temp-data")),("undefined"==typeof XMLHttpRequest||null===XMLHttpRequest)&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest),ConfigBootstrapper.prototype.markAsReady=function(){this.isReady=!0},ConfigBootstrapper.prototype.ready=function(callback){var cbs=this;cbs.isReady?callback(cbs.getData()):cbs.timeoutCounter<=cbs.timeout?(cbs.timeoutCounter=cbs.timeoutCounter+cbs.readyPollRate,setTimeout(function(){cbs.ready(callback)},cbs.readyPollRate)):callback(cbs.getData())},ConfigBootstrapper.prototype.getData=function(){var data;try{data=JSON.parse(localStorage.getItem(this.options.dataStorageKey))}catch(e){data={}}return data},ConfigBootstrapper.prototype._loadData=function(){var cbs,ts,now,xhr;cbs=this,ts=parseInt(localStorage.getItem(cbs.options.timestampStorageKey),10),now=Date.now(),!ts||now>=ts+1e3*cbs.options.refreshRate?(xhr=new XMLHttpRequest,xhr.open("GET",cbs.options.url,!0),xhr.onreadystatechange=function(){4==xhr.readyState&&(200==xhr.status&&(localStorage.setItem(cbs.options.dataStorageKey,xhr.responseText),localStorage.setItem(cbs.options.timestampStorageKey,now)),cbs.markAsReady())},xhr.send()):cbs.markAsReady()},ConfigBootstrapper});